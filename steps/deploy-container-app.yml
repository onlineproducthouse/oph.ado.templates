parameters:
  - name: awsRegion
    type: string

  - name: dkrECRUrl
    type: string
  - name: dkrTag
    type: string

  - name: ecsTaskDefFamily
    type: string
  - name: ecsRoleArn
    type: string
  - name: ecsCpu
    type: string
  - name: ecsMemory
    type: string
  - name: ecsClusterName
    type: string
  - name: ecsSvcName
    type: string
  - name: dotEnvFileStorePath
    type: string

  - name: port
    type: number
    default: 0

variables:
  - name: ecsFolder
    value: ${{ parameters.ciFolder }}/ecs
  - name: ecsTaskDefTemplate
    value: ${{ variables.ecsFolder }}/task.json
  - name: ecsTask
    value: ${{ variables.ecsFolder }}/task-ecs.json

steps:
  - script: |
      touch ${{ parameters.ecsTaskDefTemplate }}
      touch ${{ parameters.ecsTask }}

      aws ecr get-login-password | docker login --username AWS --password-stdin ${{ parameters.dkrECRUrl }}

      ECS_PORT_MAPPING='[]'
      if [[ ${{ parameters.port }} != "0" ]]; then
        ECS_PORT_MAPPING='[
          {
            "name": "${{ parameters.ecsTaskDefFamily }}",
            "protocol": "tcp",
            "containerPort": ${{ parameters.port }},
            "hostPort": ${{ parameters.port }}
          }
        ]'
      fi

      echo '{
        "family": "${{ parameters.ecsTaskDefFamily }}",
        "taskRoleArn": "${{ parameters.ecsRoleArn }}",
        "executionRoleArn": "${{ parameters.ecsRoleArn }}",
        "networkMode": "host",
        "requiresCompatibilities": ["EC2"],
        "cpu": "${{ parameters.ecsCpu }}",
        "memory": "${{ parameters.ecsMemory }}",
        "containerDefinitions": [
          {
            "name": "${{ parameters.ecsTaskDefFamily }}",
            "essential": true,
            "image": "${{ parameters.dkrTag }}",
            "cpu": ${{ parameters.ecsCpu }},
            "memory": ${{ parameters.ecsMemory }},
            "portMappings": ${ECS_PORT_MAPPING},
            "logConfiguration": {
              "logDriver": "awslogs",
              "options": {
                "awslogs-group": "${{ parameters.ecsTaskDefFamily }}",
                "awslogs-region": "${{ parameters.awsRegion }}",
                "awslogs-stream-prefix": "${{ parameters.ecsTaskDefFamily }}"
              }
            },
            "environmentFiles": [
              {
                "value": "arn:aws:s3:::${{ parameters.dotEnvFileStorePath }}",
                "type": "s3"
              }
            ]
          }
        ]
      }' >${{ parameters.ecsTaskDefTemplate }}

      echo $(cat ${{ parameters.ecsTaskDefTemplate }}) >${{ parameters.ecsTask }}

      aws ecs register-task-definition \
        --family ${{ parameters.ecsTaskDefFamily }} \
        --cli-input-json file://${{ parameters.ecsTask }}

      TASK_REVISION=aws ecs describe-task-definition --task-definition ${{ parameters.ecsTaskDefFamily }} | jq '.taskDefinition.revision'

      aws ecs update-service \
        --force-new-deployment \
        --cluster ${{ parameters.ecsClusterName }} \
        --service ${{ parameters.ecsSvcName }} \
        --task-definition ${{ parameters.ecsTaskDefFamily }}:$TASK_REVISION

    name: DeployContainerApp
