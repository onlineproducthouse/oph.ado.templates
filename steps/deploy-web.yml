parameters:
  - name: projectName
    type: string

  - name: awsRegion
    type: string
    default: ci

  # semi-colon separated list, e.g. "path1;path2;..."
  - name: awsSSMParamPath
    type: string

  - name: ciFolder
    type: string
    default: ci

  - name: loadEnvVarScriptUrl
    type: string

  - name: artifactName
    type: string

  - name: cdnId
    type: string

steps:
  - download: current
    displayName: download artifact - ${{ parameters.projectName }} - ${{ parameters.artifactName }}
    artifact: ${{ parameters.artifactName }}
    patterns: "**/*"

  - template: ./load-env-vars.yml
    parameters:
      projectName: ${{ parameters.projectName }}
      awsRegion: ${{ parameters.awsRegion }}
      awsSSMParamPath: ${{ parameters.awsSSMParamPath }}
      ciFolder: ${{ parameters.ciFolder }}
      loadEnvVarScriptUrl: ${{ parameters.loadEnvVarScriptUrl }}

  - displayName: deploy web - ${{ parameters.projectName }}
    script: |
      aws s3 sync ${{ parameters.artifactName }} "s3://$S3_HOST_BUCKET_URL"

      echo '{
        "Paths": {
          "Quantity": 1,
          "Items": ["/*"]
        },
        "CallerReference": "'$(Build.BuildNumber)'"
      }' >"$(pwd)/${{ parameters.ciFolder }}/inv-batch.json"

      echo $(aws cloudfront create-invalidation \
        --distribution-id ${{ parameters.cdnId }} \
        --invalidation-batch "file://$(pwd)/${{ parameters.ciFolder }}/inv-batch.json")
