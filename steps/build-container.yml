parameters:
  - name: projectName
    type: string

  - name: awsRegion
    type: string
    default: ci

  # semi-colon separated list, e.g. "path1;path2;..."
  - name: awsSSMParamPath
    type: string

  - name: ciFolder
    type: string
    default: ci

  - name: loadEnvVarScriptUrl
    type: string

  - name: dkrImageTag
    type: string

  - name: artifactName
    type: string

  - name: artifactDir
    type: string

steps:
  - template: ./load-env-vars.yml
    parameters:
      projectName: ${{ parameters.projectName }}
      awsRegion: ${{ parameters.awsRegion }}
      awsSSMParamPath: ${{ parameters.awsSSMParamPath }}
      ciFolder: ${{ parameters.ciFolder }}
      loadEnvVarScriptUrl: ${{ parameters.loadEnvVarScriptUrl }}

  - displayName: build container - ${{ parameters.projectName }}
    script: |
      echo $(aws ecr get-login-password | docker login --username AWS --password-stdin $IMAGE_REGISTRY_BASE_URL)
      IMAGE_TAG="$IMAGE_REPOSITORY_NAME:${{ parameters.dkrImageTag }}"
      docker buildx create --use --name multiarch
      docker buildx build --push \
        --force-rm \
        --platform=linux/arm64,linux/amd64 \
        --tag $IMAGE_REGISTRY_BASE_URL/$IMAGE_TAG \
        --build-arg IMAGE_REGISTRY_BASE_URL=$IMAGE_REGISTRY_BASE_URL \
        --file $DOCKERFILE \

  - template: ./post-build.yml
    parameters:
      projectName: ${{ parameters.projectName }}
      artifactName: ${{ parameters.artifactName }}
      artifactDir: ${{ parameters.artifactDir }}
